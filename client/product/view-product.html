<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Details</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>

<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div class="bg-white max-w-4xl w-full p-8 rounded-lg shadow-lg text-center" id="product-detail">
        <!-- Product details will be dynamically loaded here -->
    </div>

    <script>
        let currentProduct = null; // Global variable to store the product data

        async function loadProduct() {
            const productId = window.location.pathname.split('/').pop();
            const apiUrl = `/api/product/${productId}`;
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error('Product not found');
                }
                currentProduct = await response.json(); // Store product data in global variable

                const productDetail = document.getElementById('product-detail');
                productDetail.innerHTML = `
                    <h1 class="text-3xl font-semibold text-gray-800">${currentProduct.name}</h1>
                    <img src="${currentProduct.image}" alt="${currentProduct.name}" class="w-full h-auto rounded-lg mt-4">
                    <p class="text-gray-700 mt-4">${currentProduct.description}</p>
                    <p class="text-2xl font-bold text-green-600 mt-2">â‚¹${currentProduct.price}</p>
                    <p class="text-xl text-red-600 mt-2">Stock: ${currentProduct.stock}</p>
                    <input type="number" id="quantity" class="mt-4 p-2 border border-gray-300 rounded-lg w-full max-w-xs" min="1" max="${currentProduct.stock}" placeholder="Quantity" />
                    <button class="mt-4 px-4 py-2 text-white bg-blue-600 rounded-lg hover:bg-blue-700 disabled:bg-gray-500" id="place-order">Place Order</button>
                `;

                document.getElementById('place-order').addEventListener('click', placeOrder);
            } catch (error) {
                const productDetail = document.getElementById('product-detail');
                productDetail.innerHTML = `
                    <h1 class="text-3xl font-semibold text-gray-800">Product Not Found</h1>
                    <p class="text-gray-700 mt-4">${error.message}</p>
                `;
            }
        }

        function getAuthToken() {
            return localStorage.getItem('token') || '';
        }

        async function placeOrder() {
            if (!currentProduct) {
                alert('No product data available');
                return;
            }

            const quantity = parseInt(document.getElementById('quantity').value, 10);
            if (isNaN(quantity) || quantity < 1 || quantity > currentProduct.stock) {
                alert('Invalid quantity');
                return;
            }

            const order = {
                products: [{
                    product: currentProduct._id, // Use product ID as a string
                    quantity: quantity,
                    price: currentProduct.price
                }],
                totalAmount: currentProduct.price * quantity // Calculate total amount
            };

            try {
                const response = await fetch('/api/order/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`
                    },
                    body: JSON.stringify(order)
                });
                if (!response.ok) {
                    throw new Error('Order placement failed');
                }
                const result = await response.json();
                alert('Order placed successfully');
                window.location.href = '/user/orders';
                // Optionally, you can redirect the user or clear the form
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        loadProduct();
    </script>

</body>

</html>